// ClientUI.js
(function($){
Type.registerNamespace('ClientUI.D3Api');Type.registerNamespace('ClientUI');ClientUI.ResourceStrings=function(){}
Type.registerNamespace('ClientUI.ViewModels');ClientUI.ViewModels.EntityLink=function(){}
ClientUI.ViewModels.EntityLink.prototype={source:null,overflowedSource:null,target:null,overflowedTarget:null,id:null}
ClientUI.ViewModels.EntityNodeLink=function(node,link,weight){this.target=node;this.weight=weight;this.link=link;}
ClientUI.ViewModels.EntityNodeLink.prototype={target:null,link:null,weight:0}
ClientUI.ViewModels.EntityNode=function(name,size){this.links=[];this.name=name;this.size=size;}
ClientUI.ViewModels.EntityNode.$0=function($p0,$p1){var $0=null;if($p0==null){return null;}if(Object.keyExists($p1.formattedValues,$p0+'name')){return $p1.formattedValues[$p0+'name'];}else{var $1=$p1.getAttributeValue($p0);if($1==null){return $0;}var $2=Type.getInstanceType($1);switch($2.get_name()){case 'EntityReference':$0=($1).name;break;default:$0=$1.toString();break;}}return $0;}
ClientUI.ViewModels.EntityNode.prototype={name:null,size:null,id:null,x:null,y:null,sourceData:null,overflowNode:null,replacedByOverflow:null,children:null,_Children:null,linkedToIds:null,loadedActivities:false,loadedConnections:false,activityCount:0,isActivity:false,parentNode:null,fixed:false,root:false,GetQuickViewForm:function(vm){var $0=this.sourceData;if($0==null){return null;}var $1=[];if(Object.keyExists(vm.config.quickViewForms,$0.logicalName)){var $enum1=ss.IEnumerator.getEnumerator(Object.keys(vm.config.quickViewForms[$0.logicalName]));while($enum1.moveNext()){var $2=$enum1.current;var $3=vm.config.quickViewForms[$0.logicalName][$2];var $4=ClientUI.ViewModels.EntityNode.$0($2,$0);$1.add(new ClientUI.ViewModels.FormCell($3,$4));}}return $1;}}
ClientUI.ViewModels.FormCell=function(label,value){this.label=label;this.value=value;}
ClientUI.ViewModels.FormCell.prototype={label:null,value:null}
ClientUI.ViewModels.NetworkViewModel=function(id,logicalName,config){this.DemoMode=ko.observable(true);this.Iterations=ko.observable(0);this.LoadIsPaused=ko.observable(false);this.nodes=[];this.links=[];this.queue=[];this.idIndex={};this.idIndexQueried={};this.linkIndex={};this.idIndexActivityLoad={};this.idIndexConnectionLoad={};this.emailDomains={};this.ConnectionRoles=ko.observableArray();this.$1_1={};this.$1_2={};this.highlightedEntitiesToRemove=ko.observableArray();this.HighlightedLinks=ko.observableArray();this.highlightedLinksToRemove=ko.observableArray();this.$1_3={};this.$1_4={};this.SelectedNode=ko.observable(new ClientUI.ViewModels.EntityNode(null,0));this.SelectedConnectionRoles=ko.observableArray();this.tooManyNodes=ko.observable(false);this.userContacts={};ClientUI.ViewModels.NetworkViewModel.initializeBase(this);this.UsersAndTeams=ko.observableArray();this.highlightedEntities=ko.observableArray();this.SelectedUserId=ko.observable();this.rootEntityId=id;if(ss.isNullOrUndefined(this.rootEntityId)){this.rootEntityId=new SparkleXrm.Sdk.Guid('6F456AE5-237A-E711-A953-000D3AB4A3E9');}else{this.rootEntityId.value=this.$1_20(this.rootEntityId.value);}this.rootEntityLogicalName=logicalName;this.config=config;if(typeof(this.config)==='undefined'){this.cancelRequested=true;window.setTimeout(ss.Delegate.create(this,function(){
this.$1_15(new Error(ClientUI.ResourceStrings.noConfigurationError));}),100);return;}if((typeof(this.config.demoModeInitialState)!=='undefined')){this.DemoMode(config.demoModeInitialState);}if((typeof(this.config.iterationCountPerLoad)==='undefined')){this.config.iterationCountPerLoad=this.$1_6;}if(this.config.entities!=null&&Object.getKeyCount(this.config.entities)>0){this.queue.enqueue(new ClientUI.ViewModels.QueuedLoad([[id.value]],this.config.entities[logicalName],null));}this.$1_39();}
ClientUI.ViewModels.NetworkViewModel.$1_29=function($p0){var $0=null;var $1=$p0.split('@');if($1.length>1){$0=$1[1];}return $0;}
ClientUI.ViewModels.NetworkViewModel.$1_30=function($p0,$p1,$p2,$p3,$p4){if($p1.linkedToIds==null){$p1.linkedToIds={};}if($p0.linkedToIds==null){$p0.linkedToIds={};}$p1.linkedToIds[$p3.id]=new ClientUI.ViewModels.EntityNodeLink($p0,$p4,1);$p0.linkedToIds[$p2.id]=new ClientUI.ViewModels.EntityNodeLink($p1,$p4,1);}
ClientUI.ViewModels.NetworkViewModel.prototype={config:null,$1_0:0,SelectedUserId:null,rootEntityId:null,rootEntityLogicalName:null,_currentLoad:null,suspendLayout:false,UsersAndTeams:null,highlightedEntities:null,$1_5:null,cancelRequested:false,$1_6:10,$1_7:1000,$1_8:0,$1_9:0,$1_A:0,$1_B:5,add_onNewNodes:function(value){this.$1_C=ss.Delegate.combine(this.$1_C,value);},remove_onNewNodes:function(value){this.$1_C=ss.Delegate.remove(this.$1_C,value);},$1_C:null,add_onSelectedNodesCleared:function(value){this.$1_D=ss.Delegate.combine(this.$1_D,value);},remove_onSelectedNodesCleared:function(value){this.$1_D=ss.Delegate.remove(this.$1_D,value);},$1_D:null,add_onSelectedNodesAdded:function(value){this.$1_E=ss.Delegate.combine(this.$1_E,value);},remove_onSelectedNodesAdded:function(value){this.$1_E=ss.Delegate.remove(this.$1_E,value);},$1_E:null,add_onSelectedLinksAdded:function(value){this.$1_F=ss.Delegate.combine(this.$1_F,value);},remove_onSelectedLinksAdded:function(value){this.$1_F=ss.Delegate.remove(this.$1_F,value);},$1_F:null,add_onInfoBoxClose:function(value){this.$1_10=ss.Delegate.combine(this.$1_10,value);},remove_onInfoBoxClose:function(value){this.$1_10=ss.Delegate.remove(this.$1_10,value);},$1_10:null,add_onZoom:function(value){this.$1_11=ss.Delegate.combine(this.$1_11,value);},remove_onZoom:function(value){this.$1_11=ss.Delegate.remove(this.$1_11,value);},$1_11:null,CancelCommand:function(){this.cancelRequested=true;this.isBusy(false);},DrillIntoCommand:function(){var $0=this.SelectedNode().sourceData;ClientUI.ViewModels.XrmForm.openRecordInNewWindow($0.id,$0.logicalName);},LoadMoreCommand:function(){this.LoadIsPaused(false);this.Iterations(0);this.processQueue();},CloseInfoBoxCommand:function(){this.$1_10(this,null);},ConnectionRoleClickCommand:function(that,role){this.DemoMode(false);this.SelectedUserId(null);this.$1_13();if(!Object.keyExists(this.$1_2,role)){return;}if(this.SelectedConnectionRoles().contains(role)){this.SelectedConnectionRoles.remove(role);var $enum1=ss.IEnumerator.getEnumerator(Object.keys(this.$1_2[role]));while($enum1.moveNext()){var $0=$enum1.current;this.$1_12($0,false);}}else{this.SelectedConnectionRoles.push(role);var $enum2=ss.IEnumerator.getEnumerator(Object.keys(this.$1_2[role]));while($enum2.moveNext()){var $1=$enum2.current;this.$1_12($1,true);}}if(this.$1_F!=null){this.$1_F(this,null);}if(this.$1_E!=null){this.$1_E(this,null);}},$1_12:function($p0,$p1){if($p1){this.HighlightedLinks.push($p0);}else{this.HighlightedLinks.remove($p0);this.highlightedLinksToRemove.push($p0);}var $0=this.linkIndex[$p0];if($0!=null){var $1=$0.source;if($1!=null){var $3=($1.sourceData).toEntityReference();if($p1){this.highlightedEntities.push($3);}else{this.highlightedEntities.remove($3);this.highlightedEntitiesToRemove.push($3);}}var $2=$0.target;if($2!=null){var $4=($2.sourceData).toEntityReference();if($p1){this.highlightedEntities.push($4);}else{this.highlightedEntities.remove($4);this.highlightedEntitiesToRemove.push($4);}}}},UserClickCommand:function(that,user){this.DemoMode(false);this.$1_13();var $0=false;if(user==null||that.SelectedUserId()===user.id){that.SelectedUserId(null);}else{that.SelectedUserId(user.id);$0=true;}if($0){var $enum1=ss.IEnumerator.getEnumerator(Object.keys(user.Parties));while($enum1.moveNext()){var $1=$enum1.current;var $2=user.Parties[$1];var $3=this.$1_33($2);if(Object.keyExists(this.idIndex,$3)&&this.idIndex[$3].replacedByOverflow!=null){var $4=this.idIndex[this.$1_33($2)].replacedByOverflow.sourceData;this.highlightedEntities.push(new SparkleXrm.Sdk.EntityReference(new SparkleXrm.Sdk.Guid($4.id),$4.logicalName,null));}else{this.highlightedEntities.push($2);}}}if(this.$1_E!=null){this.$1_E(this,null);}if(this.$1_F!=null){this.$1_F(this,null);}},$1_13:function(){this.SelectedConnectionRoles.removeAll();var $enum1=ss.IEnumerator.getEnumerator(this.HighlightedLinks());while($enum1.moveNext()){var $0=$enum1.current;this.highlightedLinksToRemove.push($0);}this.HighlightedLinks.removeAll();var $enum2=ss.IEnumerator.getEnumerator(this.highlightedEntities());while($enum2.moveNext()){var $1=$enum2.current;this.highlightedEntitiesToRemove.push($1);}this.highlightedEntities.removeAll();},ZoomInCommand:function(){if(this.$1_11!=null){this.$1_11(this,1);}},ZoomOutCommand:function(){if(this.$1_11!=null){this.$1_11(this,-1);}},DemoModeClickCommand:function(){var $0=!this.DemoMode();this.DemoMode($0);if($0){this.$1_0=0;this.$1_39();}},$1_14:function(){if(this.cancelRequested){this.isBusy(false);}return this.cancelRequested;},$1_15:function($p0){this.isBusy(true);this.isBusyMessage($p0.message);},processQueue:function(){if(this.$1_14()){return;}if(!this.isBusy()){this.isBusy(true);}this.$1_8++;this.$1_1B('--------------------{0}',[this.$1_8]);var $0='';var $enum1=ss.IEnumerator.getEnumerator(this.queue);while($enum1.moveNext()){var $1=$enum1.current;$0+=$1.entity.logicalName;if($1.join!=null){if($1.join.rightEntity==='connection'||$1.join.rightEntity==='activity'){$0+=('['+$1.join.rightEntity+']');}else{$0+=('['+$1.join.leftEntity+'.'+$1.join.leftAttribute+' = '+$1.join.rightEntity+'.'+$1.join.rightAttribute+']');}}$0+=' | ';}this.$1_1B('Queue = {0}',[$0]);this.$1_1B('--------------------{0}',[this.$1_8]);if(this.$1_8>this.$1_7){this.$1_1A(ClientUI.ResourceStrings.possibleInfiniteLoop);this.$1_8=0;return;}if(this._currentLoad==null){this._currentLoad=this.queue.dequeue();if(this._currentLoad==null){this.$1_17();this.raiseOnNodesChanged();this._currentLoad=this.queue.dequeue();if(this._currentLoad==null){this.isBusy(false);this.$1_1B('End of Queue',null);return;}}}this.$1_16();if(this._currentLoad.join==null){if(!this.$1_19()){return;}this.$1_1B('Entity Query {0} ',[this._currentLoad.entity.logicalName]);this.$1_1C('Loading',this._currentLoad.entity.displayName,0,0);var $2=[];var $enum2=ss.IEnumerator.getEnumerator(this._currentLoad.ids);while($enum2.moveNext()){var $3=$enum2.current;var $4=this.$1_34(this._currentLoad.entity.logicalName,$3);if(Object.keyExists(this.idIndexQueried,$4)){this.$1_2C(this._currentLoad.entity.logicalName,$3);continue;}else{this.idIndexQueried[$4]=$4;}$2.add($3);}if($2.length>0){var $5=(this._currentLoad.entity.hierarchical)?'eq-above-under':'eq';var $6=this.$1_21(this._currentLoad.entity.logicalName,this._currentLoad.entity.idAttribute,$5,$2);var $7=String.format('\n\n<!-- '+this.isBusyMessage()+'-->\n\n'+this._currentLoad.entity.fetchXml,$6);this.$1_1E(this._currentLoad,$7);}else{this._currentLoad=null;this.$1_18();return;}}else if(this._currentLoad.join.rightEntity==='activity'){this._currentLoad=null;this.$1_22();return;}else if(this._currentLoad.join.rightEntity==='connection'){this._currentLoad=null;this.$1_24();return;}else if(this._currentLoad.join!=null){this.$1_1B('Join Query {0}->{1}',[this._currentLoad.join.leftEntity,this._currentLoad.join.rightEntity]);this.$1_1C('Joining',this._currentLoad.entity.displayName,0,0);if(this._currentLoad.ids.length>0){var $8=[];var $enum3=ss.IEnumerator.getEnumerator(this._currentLoad.ids);while($enum3.moveNext()){var $9=$enum3.current;var $A=this.idIndex[this.$1_33(new SparkleXrm.Sdk.EntityReference(new SparkleXrm.Sdk.Guid($9),this._currentLoad.join.leftEntity,null))];if($A!=null){var $B=($A.sourceData).getAttributeValue(this._currentLoad.join.leftAttribute);if($B!=null){if(Type.getInstanceType($B)===SparkleXrm.Sdk.Guid){$8.add(($B).value);}else if(Type.getInstanceType($B)===SparkleXrm.Sdk.EntityReference){$8.add(($B).id.value);}}}}if($8.length>0){this.$1_1B('Found {0} Join IDs',[$8.length]);var $C=this._currentLoad.join;var $D=(this._currentLoad.entity.hierarchical&&$C.rightAttribute===this._currentLoad.entity.idAttribute)?'eq-above-under':'eq';var $E=[];if($C.excludeIds==null){$C.excludeIds={};}var $enum4=ss.IEnumerator.getEnumerator($8);while($enum4.moveNext()){var $F=$enum4.current;if(!Object.keyExists($C.excludeIds,'ID'+$F)){$E.add($F);$C.excludeIds['ID'+$F]=$F;}}if($E.length>0){this.$1_1B('Correted Join IDS {0}',[$E.length]);var $10=String.format('\n\n<!-- '+this.isBusyMessage()+'-->\n\n'+this._currentLoad.entity.fetchXml,this.$1_21(this._currentLoad.entity.logicalName,this._currentLoad.join.rightAttribute,$D,$E));this.$1_1E(this._currentLoad,$10);}else{this.$1_1B('Join supressed due to infinite loop possibility',null);this._currentLoad=null;this.$1_18();}return;}else{this.$1_1B('Nothing to Load',null);this._currentLoad=null;this.$1_18();return;}}else{this.$1_18();return;}}},$1_16:function(){var $0=this.queue.peek();if($0!=null&&($0.entity.logicalName===this._currentLoad.entity.logicalName)){var $1=(this._currentLoad.join!=null)?this._currentLoad.join.rightEntity:null;var $2=($0.join!=null)?$0.join.rightEntity:null;if($1===$2){this.$1_1B('Next Load is same join',null);var $3=this.queue.dequeue();this._currentLoad.ids.addRange($3.ids);}}},$1_17:function(){var $enum1=ss.IEnumerator.getEnumerator(Object.keys(this.$1_4));while($enum1.moveNext()){var $0=$enum1.current;this.$1_1B('Pending Entity {0}',[$0]);var $1=this.config.entities[$0];if($1!=null&&Object.getKeyCount(this.$1_4[$0])>0){this.queue.enqueue(new ClientUI.ViewModels.QueuedLoad(Object.keys(this.$1_4[$0]),$1,null));this.$1_1B('Queued {0}',[$0]);}else{this.$1_1B('Nothing to Load',null);}}},$1_18:function(){if(this.$1_5==null){this.$1_5=Date.get_now();}if((this.$1_5-Date.get_now())>3000){this.$1_5=Date.get_now();window.setTimeout(ss.Delegate.create(this,function(){
this.processQueue();}),100);}else{this.processQueue();}},$1_19:function(){var $0=this.Iterations();$0++;this.Iterations($0);if($0<this.config.iterationCountPerLoad){return true;}else{this.$1_1A(ClientUI.ResourceStrings.recordLimitExceeded);return false;}},$1_1A:function($p0){this.isBusyMessage($p0);this.LoadIsPaused(true);this.raiseOnNodesChanged();},$1_1B:function($p0,$p1){if(this.config.trace){var $0=($p1!=null&&$p1.length>0)?$p1[0]:null;var $1=($p1!=null&&$p1.length>1)?$p1[1]:null;var $2=($p1!=null&&$p1.length>2)?$p1[2]:null;var $3=($p1!=null&&$p1.length>3)?$p1[3]:null;var $4=($p1!=null&&$p1.length>4)?$p1[4]:null;var $5=String.format($p0,$0,$1,$2,$3);ss.Debug.writeln($5);}},$1_1C:function($p0,$p1,$p2,$p3){var $0=String.format(ClientUI.ResourceStrings.statusMessage,$p0,$p1,this.nodes.length);this.isBusyMessage($0);this.isBusyProgress(($p2/$p3)*100);},$1_1D:function($p0,$p1,$p2){var $0=$p0.getAttributeValue($p1);var $1='';if(Type.getInstanceType($0)===SparkleXrm.Sdk.Guid){$1=($0).value;}else if(Type.getInstanceType($0)===SparkleXrm.Sdk.EntityReference){$1=($0).id.value;$p2=($0).logicalName;}var $2=null;if($0!=null){var $3=$p2+$1;if(Object.keyExists(this.idIndex,$3)){$2=this.idIndex[$3];}}return $2;},$1_1E:function($p0,$p1){this.$1_1C(ClientUI.ResourceStrings.querying,$p0.entity.displayName,0,0);SparkleXrm.Sdk.OrganizationServiceProxy.beginRetrieveMultiple($p1,ss.Delegate.create(this,function($p1_0){
try{var $1_0=SparkleXrm.Sdk.OrganizationServiceProxy.endRetrieveMultiple($p1_0,SparkleXrm.Sdk.Entity);this.$1_1B('Query for {0} returned {1} records',[$p0.entity.logicalName,$1_0.get_entities().get_count()]);this.$1_1F($p0,$1_0);}catch($1_1){this.$1_15($1_1);return;}}));},$1_1F:function($p0,$p1){var $0=$p1.get_entities().get_count();var $1=0;var $2=[];var $enum1=ss.IEnumerator.getEnumerator($p1.get_entities());while($enum1.moveNext()){var $3=$enum1.current;if(this.$1_14()){return;}this.$1_1C(ClientUI.ResourceStrings.processing,$p0.entity.displayName,$1,$0);this.$1_2C($3.logicalName,$3.id);$1++;$2.add($3.id);var $4=$3.getAttributeValueString(($p0.entity.nameAttribute==null)?'name':$p0.entity.nameAttribute);var $5=this.rootEntityId.value===$3.id.toLowerCase();if($5){window.document.title=$4;}if(!this.$1_27($3)&&!this.$1_35($3)){var $6=new ClientUI.ViewModels.EntityNode($4,100);$6.root=$5;$6.x=this.$1_9;$6.y=this.$1_A;$6.sourceData=$3;if(!this.$1_31($3,$6,$p0.entity,false)){return;}var $7=$3.getAttributeValueEntityReference('ownerid');if($7!=null){var $8=this.getUserOrTeamReference($7);$8.Parties[$3.id]=$3.toEntityReference();}}}this.$1_1B('Linking to Parents {0} {1} records',[$p0.entity.logicalName,$p1.get_entities().get_count()]);$1=0;var $enum2=ss.IEnumerator.getEnumerator($p1.get_entities());while($enum2.moveNext()){var $9=$enum2.current;if(this.$1_14()){return;}this.$1_1C(ClientUI.ResourceStrings.linking,$p0.entity.displayName,$1,$0);var $A=this.$1_37($9);if($A==null){continue;}var $B=this.$1_1D($9,$p0.entity.parentAttributeId,$p0.entity.logicalName);if($B!=null){this.$1_2D($A,$B,false);}if($p0.join!=null){this.$1_1B('Adding backlinks {0}->{1}',[$p0.entity.logicalName,$p0.join.rightEntity]);var $C=this.$1_1D($9,$p0.join.rightAttribute,$p0.join.rightEntity);if($C!=null){this.$1_2D($A,$C,false);}else{}}}if($2.length>0){if($p0.entity.joins!=null){this.$1_1B('Adding Joins to {0}',[$2.length]);var $enum3=ss.IEnumerator.getEnumerator($p0.entity.joins);while($enum3.moveNext()){var $D=$enum3.current;var $E=this.config.entities[$D.rightEntity];if($E!=null){this.$1_1B('Queing Join  {0}.{1} -> {2}.{3} {4}',[$D.leftEntity,$D.leftAttribute,$D.rightEntity,$D.rightAttribute,$D.name]);this.queue.enqueue(new ClientUI.ViewModels.QueuedLoad($2,$E,$D));}}}if($p0.entity.loadActivities){this.queue.enqueue(new ClientUI.ViewModels.QueuedLoad($2,$p0.entity,this.$1_2A($p0.entity.logicalName,'activity')));}if($p0.entity.loadConnections){this.queue.enqueue(new ClientUI.ViewModels.QueuedLoad($2,$p0.entity,this.$1_2A($p0.entity.logicalName,'connection')));}}this._currentLoad=null;this.$1_18();},$1_20:function($p0){if($p0.substr(0,1)==='{'){$p0=$p0.substr(1,36);}return $p0.toLowerCase();},$1_21:function($p0,$p1,$p2,$p3){var $0="<filter type='or'>";if($p2==='eq-above-under'){var $enum1=ss.IEnumerator.getEnumerator($p3);while($enum1.moveNext()){var $1=$enum1.current;$0+=String.format("<condition attribute='{0}' operator='{2}' value='{1}'/>",$p1,$1,'eq-or-above');$0+=String.format("<condition attribute='{0}' operator='{2}' value='{1}'/>",$p1,$1,'under');}}else{var $enum2=ss.IEnumerator.getEnumerator($p3);while($enum2.moveNext()){var $2=$enum2.current;$0+=String.format("<condition attribute='{0}' operator='{2}' value='{1}'/>",$p1,$2,$p2);}}$0+='</filter>';return $0;},$1_22:function(){if(this.$1_14()){return;}this.$1_1C(ClientUI.ResourceStrings.loading,ClientUI.ResourceStrings.activities,0,0);var $0='';var $enum1=ss.IEnumerator.getEnumerator(Object.keys(this.idIndexActivityLoad));while($enum1.moveNext()){var $1=$enum1.current;$0+='<value>'+(this.idIndexActivityLoad[$1].sourceData).id+'</value>';}Object.clearKeys(this.idIndexActivityLoad);if(!!$0){var $2=String.format(this.config.acitvityFetchXml,$0);SparkleXrm.Sdk.OrganizationServiceProxy.beginRetrieveMultiple($2,ss.Delegate.create(this,function($p1_0){
if(this.$1_14()){return;}var $1_0;var $1_1=0;try{$1_0=SparkleXrm.Sdk.OrganizationServiceProxy.endRetrieveMultiple($p1_0,SparkleXrm.Sdk.Entity);$1_1=$1_0.get_entities().get_count();}catch($1_2){this.$1_15($1_2);return;}SparkleXrm.DelegateItterator.callbackItterate(ss.Delegate.create(this,function($p2_0,$p2_1,$p2_2){
if(this.$1_14()){return;}this.$1_23($1_0,$p2_0,$1_1);$p2_1();}),$1_1,ss.Delegate.create(this,function(){
this.$1_28(ss.Delegate.create(this,function(){
this._currentLoad=null;this.$1_18();return;}));}),function($p2_0){
});}));}else{this._currentLoad=null;this.$1_18();return;}},$1_23:function($p0,$p1,$p2){var $0=$p0.get_entities().get_item($p1);this.$1_1C(ClientUI.ResourceStrings.processing,ClientUI.ResourceStrings.activities,$p1,$p2);var $1;$0.logicalName=$0.getAttributeValueString('activitytypecode');var $2=false;if(!this.$1_35($0)){$1=new ClientUI.ViewModels.EntityNode($0.getAttributeValueString('name'),100);$1.isActivity=true;$1.x=this.$1_9;$1.y=this.$1_A;$1.sourceData=$0;if(!this.$1_31($0,$1,null,true)){return;}}else{$1=this.$1_37($0);$2=true;}var $3=$0.getAttributeValue('allparties');var $4=0;var $5=false;var $enum1=ss.IEnumerator.getEnumerator($3.get_entities());while($enum1.moveNext()){var $6=$enum1.current;if(this.$1_14()){return;}if(!($p1%20)){this.$1_1C(ClientUI.ResourceStrings.processing,ClientUI.ResourceStrings.activityLinks,$p1,$p2);}$4++;var $7=$6;var $8=$7.partyid;if($8!=null){var $9=this.$1_2F($1,$8,true);if($9==null){if($7.partyid.logicalName==='systemuser'||$7.partyid.logicalName==='team'){$7.activityid.logicalName=($1.sourceData).logicalName;var $A=this.getUserOrTeamReference($7.partyid);$A.Parties[$7.activityid.id.toString()]=$7.activityid;}else{this.$1_2E($1,$8);}}else{if($1.parentNode==null){$1.parentNode=$9.target;$1.parentNode.activityCount++;}var $B=false;var $C=$1.parentNode.activityCount>this.$1_B&&$1.parentNode===$9.target;if($2){$5=false;}if($C){if($1.parentNode.overflowNode==null){var $D=new ClientUI.ViewModels.EntityNode(ClientUI.ResourceStrings.doubleClickToExpand,1);$D.id='overflow'+$8.id.value;$D.parentNode=$1.parentNode;$D.x=this.$1_9;$D.y=this.$1_A;var $E=new SparkleXrm.Sdk.Entity('overflow');$E.id='overflow'+($1.sourceData).id;$D.sourceData=$E;this.nodes.add($D);$1.parentNode.overflowNode=$D;$1.replacedByOverflow=$D;}else if($9.source.parentNode===$9.target&&!$2){$B=true;$9.source.replacedByOverflow=$9.target.overflowNode;}if($1.replacedByOverflow!=null){if($1.replacedByOverflow.children==null){$1.replacedByOverflow.children=[];}if(!$1.replacedByOverflow.children.contains($1)){$1.replacedByOverflow.children.add($1);}}}if(!$B){if($9.source.replacedByOverflow!=null){$9.source=$9.source.replacedByOverflow;$9.source.links.add($9);if(!$9.id.startsWith('overflow')){$9.id='overflow'+$9.id;}}if(!Object.keyExists(this.linkIndex,$9.id)){this.linkIndex[$9.id]=$9;this.links.add($9);}else{}}}}}if($1.replacedByOverflow==null){if(!$2){this.nodes.add($1);}}},$1_24:function(){if(this.$1_14()){return;}this.$1_1C(ClientUI.ResourceStrings.loading,ClientUI.ResourceStrings.connections,0,0);var $0='';var $1='';var $enum1=ss.IEnumerator.getEnumerator(Object.keys(this.idIndexConnectionLoad));while($enum1.moveNext()){var $2=$enum1.current;$0+='<value>'+(this.idIndexConnectionLoad[$2].sourceData).id+'</value>';$1+=this.idIndexConnectionLoad[$2].name+' , ';}Object.clearKeys(this.idIndexConnectionLoad);if(!!$0){var $3=String.format(this.config.connectionFetchXml,$0);SparkleXrm.Sdk.OrganizationServiceProxy.beginRetrieveMultiple($3,ss.Delegate.create(this,function($p1_0){
if(this.$1_14()){return;}var $1_0=null;var $1_1=0;try{$1_0=SparkleXrm.Sdk.OrganizationServiceProxy.endRetrieveMultiple($p1_0,ClientUI.ViewModels.Connection);$1_1=$1_0.get_entities().get_count();}catch($1_2){this.$1_15($1_2);return;}SparkleXrm.DelegateItterator.callbackItterate(ss.Delegate.create(this,function($p2_0,$p2_1,$p2_2){
if(this.$1_14()){return;}this.$1_25($1_0,$p2_0,$1_1);$p2_1();}),$1_1,ss.Delegate.create(this,function(){
this._currentLoad=null;this.$1_18();return;}),function($p2_0){
});}));}else{this._currentLoad=null;this.$1_18();return;}},$1_25:function($p0,$p1,$p2){var $0=$p0.get_entities().get_item($p1);this.$1_1C(ClientUI.ResourceStrings.processing,ClientUI.ResourceStrings.connections,$p1,$p2);var $1=$0.record1id;var $2=$0.record2id;var $3=$0.record1roleid;var $4=$0.record2roleid;var $5=this.$1_38($1);var $6=this.$1_2F($5,$2,false);var $7=$1.logicalName==='systemuser'||$1.logicalName==='team';var $8=$2.logicalName==='systemuser'||$2.logicalName==='team';if(!$7&&!$8&&$6!=null){if($3!=null){if(!Object.keyExists(this.$1_2,$3.name)){this.$1_2[$3.name]={};}if(!Object.keyExists(this.$1_2[$3.name],$6.id)){this.$1_2[$3.name][$6.id]=$6;}if(!this.ConnectionRoles().contains($3.name)){this.ConnectionRoles.push($3.name);}}if($4!=null){if(!Object.keyExists(this.$1_2,$4.name)){this.$1_2[$4.name]={};}if(!Object.keyExists(this.$1_2[$4.name],$6.id)){this.$1_2[$4.name][$6.id]=$6;}if(!this.ConnectionRoles().contains($4.name)){this.ConnectionRoles.push($4.name);}}}if($6==null){if($8){var $9=this.getUserOrTeamReference($2);$9.Parties[$2.id.toString()]=$1;}else if($7){var $A=this.getUserOrTeamReference($1);$A.Parties[$1.id.toString()]=$2;}else{this.$1_2E($5,$2);}}},$1_26:function($p0){var $0=new SparkleXrm.Sdk.Entity($p0.logicalName);$0.id=$p0.id.value;return this.$1_27($0);},$1_27:function($p0){if(Object.keyExists(this.userContacts,$p0.id)){return true;}else{if(($p0.logicalName==='contact'&&$p0.getAttributeValue('systemuserid')!=null)){this.userContacts[$p0.id]=$p0;return true;}if($p0.logicalName==='contact'){var $0=$p0.getAttributeValueString('emailaddress1');if($0!=null){var $1=ClientUI.ViewModels.NetworkViewModel.$1_29($0);return Object.keyExists(this.emailDomains,$1);}}}return false;},getUserOrTeamReference:function(userOrTeamId){var $0;if(!Object.keyExists(this.$1_3,userOrTeamId.id.toString())){$0=new ClientUI.ViewModels.UserOrTeam();$0.id=userOrTeamId.id.toString();$0.isTeam=(userOrTeamId.logicalName==='team');$0.logicalName=($0.isTeam)?'team':'systemuser';$0.fullname=null;$0.Parties={};this.$1_3[$0.id]=$0;}else{$0=this.$1_3[userOrTeamId.id.toString()];}return $0;},$1_28:function($p0){var $0='';var $1='';var $enum1=ss.IEnumerator.getEnumerator(Object.keys(this.$1_3));while($enum1.moveNext()){var $6=$enum1.current;var $7=this.$1_3[$6];if($7.fullname==null){if($7.isTeam){$1+='<value>'+$7.id+'</value>';}else{$0+='<value>'+$7.id+'</value>';}}}var $2=1;var $3=0;if(!$0.length&&!$1.length){$p0();return;}$2=($0.length>0&&$1.length>0)?2:1;var $4=String.format("<fetch version='1.0' output-format='xml-platform' mapping='logical' distinct='false' nolock='true'>\r\n                              <entity name='systemuser'>\r\n                                <attribute name='fullname' />\r\n                                <attribute name='systemuserid' />\r\n                                <attribute name='internalemailaddress'/>\r\n                                <filter type='and'>\r\n                                  <condition attribute='systemuserid' operator='in' >{0}</condition>\r\n                                </filter>\r\n                              </entity>\r\n                            </fetch>",$0);var $5=String.format("<fetch version='1.0' output-format='xml-platform' mapping='logical' distinct='false' nolock='true'>\r\n                              <entity name='team'>\r\n                                <attribute name='name' />\r\n                                <attribute name='teamid' />\r\n                                <filter type='and'>\r\n                                  <condition attribute='teamid' operator='in' >{0}</condition>\r\n                                </filter>\r\n                              </entity>\r\n                            </fetch>",$1);if($0.length>0){SparkleXrm.Sdk.OrganizationServiceProxy.beginRetrieveMultiple($4,ss.Delegate.create(this,function($p1_0){
if(this.$1_14()){return;}var $1_0=SparkleXrm.Sdk.OrganizationServiceProxy.endRetrieveMultiple($p1_0,ClientUI.ViewModels.UserOrTeam);var $enum1=ss.IEnumerator.getEnumerator($1_0.get_entities());while($enum1.moveNext()){var $1_1=$enum1.current;if(this.$1_14()){return;}this.$1_3[$1_1.id].fullname=$1_1.fullname;$1_1.Parties=this.$1_3[$1_1.id].Parties;if($1_1.internalemailaddress!=null){var $1_2=ClientUI.ViewModels.NetworkViewModel.$1_29($1_1.internalemailaddress);if(!Object.keyExists(this.emailDomains,$1_2)){this.emailDomains[$1_2]=$1_2;}}this.UsersAndTeams.push($1_1);}$3++;if($3>=$2){$p0();}}));}if($1.length>0){SparkleXrm.Sdk.OrganizationServiceProxy.beginRetrieveMultiple($5,ss.Delegate.create(this,function($p1_0){
if(this.$1_14()){return;}var $1_0=SparkleXrm.Sdk.OrganizationServiceProxy.endRetrieveMultiple($p1_0,ClientUI.ViewModels.UserOrTeam);var $enum1=ss.IEnumerator.getEnumerator($1_0.get_entities());while($enum1.moveNext()){var $1_1=$enum1.current;if(this.$1_14()){return;}$1_1.fullname=$1_1.name;this.$1_3[$1_1.id].fullname=$1_1.name;$1_1.isTeam=true;$1_1.Parties=this.$1_3[$1_1.id].Parties;this.UsersAndTeams.push($1_1);}$3++;if($3>=$2){$p0();}}));}},$1_2A:function($p0,$p1){var $0={};$0.leftEntity=$p0;$0.rightEntity=$p1;return $0;},$1_2B:function($p0,$p1){var $0;if($p0.compareTo($p1)>0){$0=$p0.replaceAll('-','')+'_'+$p1.replaceAll('-','');}else{$0=$p1.replaceAll('-','')+'_'+$p0.replaceAll('-','');}return 'L'+$0;},$1_2C:function($p0,$p1){if(Object.keyExists(this.$1_4,$p0)){var $0=this.$1_4[$p0];if(Object.keyExists($0,$p1)){var $1=$0[$p1];delete $0[$p1];}}},$1_2D:function($p0,$p1,$p2){var $0=$p1.sourceData;var $1=$p0.sourceData;if(($p0.linkedToIds!=null)&&($p1.linkedToIds!=null)){if(Object.keyExists($p0.linkedToIds,$0.id)&&Object.keyExists($p1.linkedToIds,$1.id)){return $p0.linkedToIds[$0.id].link;}}var $2=new ClientUI.ViewModels.EntityLink();$2.source=$p1;$2.target=$p0;ClientUI.ViewModels.NetworkViewModel.$1_30($2.target,$2.source,$0,$1,$2);if(!$p1.isActivity&&$2.source.parentNode!=null&&$2.source.parentNode.overflowNode!=null){$2.source=$2.source.parentNode.overflowNode;$2.source.links.add($2);}else if($p1.isActivity&&$2.source.overflowNode!=null){$2.source=$2.source.overflowNode;$2.source.links.add($2);}if(!$p0.isActivity&&$2.target.parentNode!=null&&$2.target.parentNode.overflowNode!=null){$2.target=$2.target.parentNode.overflowNode;}else if($p0.isActivity&&$2.target.overflowNode!=null){$2.target=$2.target.overflowNode;$2.target.links.add($2);}$2.id=this.$1_2B($0.id,$1.id);if(!Object.keyExists(this.linkIndex,$2.id)){if(!$p2){this.linkIndex[$2.id]=$2;this.links.add($2);}}return $2;},$1_2E:function($p0,$p1){this.$1_1B('Add Pending Link {0} {1} -> {2} {3}',[($p0.sourceData).logicalName,$p0.name,$p1.logicalName,$p1.id]);var $0=new ClientUI.ViewModels.PendingLink();$0.source=$p0;$0.target=$p1;if(!Object.keyExists(this.$1_4,$p1.logicalName)){this.$1_4[$p1.logicalName]={};}if(!this.$1_26($p1)){this.$1_4[$p1.logicalName][$p1.id.toString()]=$0;}return $0;},$1_2F:function($p0,$p1,$p2){var $0=this.$1_38($p1);if($0!=null){var $1=this.$1_2D($0,$p0,$p2);return $1;}return null;},$1_31:function($p0,$p1,$p2,$p3){if(!((this.nodes.length+1)%40)){this.$1_11(this,-1);}var $0=this.$1_32($p0);this.idIndex[$0]=$p1;if($p2!=null){if(!$p1.loadedActivities&&$p2.loadActivities){this.idIndexActivityLoad[$0]=$p1;$p1.loadedActivities=true;}if(!$p1.loadedConnections&&$p2.loadConnections){this.idIndexConnectionLoad[$0]=$p1;$p1.loadedConnections=true;}}if(!$p3){this.nodes.add($p1);}return true;},$1_32:function($p0){return $p0.logicalName+$p0.id;},$1_33:function($p0){return $p0.logicalName+$p0.id.toString();},$1_34:function($p0,$p1){return $p0+$p1;},$1_35:function($p0){return Object.keyExists(this.idIndex,this.$1_32($p0));},$1_36:function($p0){return Object.keyExists(this.idIndex,this.$1_33($p0));},$1_37:function($p0){return this.idIndex[this.$1_32($p0)];},$1_38:function($p0){return this.idIndex[this.$1_33($p0)];},raiseOnNodesChanged:function(){if(!this.cancelRequested){if(this.$1_C!=null){this.$1_C(this,null);}}},raiseOnNodesChangedWithNoFastForward:function(){if(!this.cancelRequested){if(this.$1_C!=null){this.$1_C(this,new ss.EventArgs());}}},expandOverflow:function(entityNode){this.SelectedUserId(null);this.SelectedConnectionRoles.removeAll();this.$1_13();this.$1_E(this,null);this.$1_F(this,null);if(entityNode.children!=null){var $0=0;var $enum1=ss.IEnumerator.getEnumerator(entityNode.children);while($enum1.moveNext()){var $1=$enum1.current;$1.x=entityNode.x;$1.y=entityNode.y;$1.fixed=false;if(!this.nodes.contains($1)){this.nodes.add($1);}$1.replacedByOverflow=null;$0++;var $dict2=$1.linkedToIds;for(var $key3 in $dict2){var $2={key:$key3,value:$dict2[$key3]};var $3=new ClientUI.ViewModels.EntityLink();$3.source=$1;$3.target=$2.value.target;$3.id=this.$1_2B(($1.sourceData).id,($3.target.sourceData).id);if(Object.keyExists(this.linkIndex,$3.id)){$3=this.linkIndex[$3.id];}else{this.linkIndex[$3.id]=$3;this.links.add($3);}}if($0===this.$1_B&&entityNode.children.length>(this.$1_B+1)){break;}}entityNode.children.removeRange(0,$0);entityNode.parentNode.activityCount=entityNode.children.length;if(!entityNode.children.length){entityNode.children=null;this.nodes.remove(entityNode);var $enum4=ss.IEnumerator.getEnumerator(entityNode.links);while($enum4.moveNext()){var $4=$enum4.current;delete this.linkIndex[$4.id];this.links.remove($4);}}this.raiseOnNodesChangedWithNoFastForward();}},$1_39:function(){if(!this.DemoMode()){return;}var $0=this.UsersAndTeams().length;var $1=this.ConnectionRoles().length;var $2=(this.$1_0-$0);if($2>=this.ConnectionRoles().length){this.$1_0=0;this.UserClickCommand(this,null);}else if(this.$1_0<$0){var $3=this.UsersAndTeams();var $4=$3[this.$1_0].id;this.UserClickCommand(this,this.$1_3[$4]);this.$1_0++;}else if($2>=0&&$2<$1){var $5=this.ConnectionRoles();var $6=$5[$2];this.ConnectionRoleClickCommand(this,$6);this.$1_0++;}this.DemoMode(true);if(this.DemoMode()){window.setTimeout(ss.Delegate.create(this,this.$1_39),(this.config.demoTickLength!=null&&this.config.demoTickLength>500)?this.config.demoTickLength:2000);}}}
ClientUI.ViewModels.PendingLink=function(){}
ClientUI.ViewModels.PendingLink.prototype={target:null,source:null}
ClientUI.ViewModels.UserOrTeam=function(){ClientUI.ViewModels.UserOrTeam.initializeBase(this,['systemuser']);this.Parties={};}
ClientUI.ViewModels.UserOrTeam.prototype={fullname:null,name:null,internalemailaddress:null,isTeam:false,Parties:null}
ClientUI.ViewModels.ActivityParty=function(){ClientUI.ViewModels.ActivityParty.initializeBase(this,['activityparty']);}
ClientUI.ViewModels.ActivityParty.prototype={activityid:null,partyid:null}
ClientUI.ViewModels.Connection=function(){ClientUI.ViewModels.Connection.initializeBase(this,['connection']);}
ClientUI.ViewModels.Connection.prototype={connectionid:null,record1id:null,record2id:null,record1roleid:null,record2roleid:null}
ClientUI.ViewModels.QueuedLoad=function(ids,entity,join){this.ids=ids;this.entity=entity;this.join=join;}
ClientUI.ViewModels.QueuedLoad.prototype={ids:null,entity:null,join:null}
ClientUI.ViewModels.XrmForm=function(){}
ClientUI.ViewModels.XrmForm.openRecordInNewWindow=function(id,typeName){try{var $0='{0}/userdefined/edit.aspx?etc={3}&id=%7b{2}%7d';var $1=Mscrm.EntityPropUtil.EntityTypeName2CodeMap[typeName];var $2=1300;var $3=900;var $4=String.format($0,Xrm.Page.context.getClientUrl(),typeName,id.replaceAll('{','').replaceAll('}',''),$1);var $5=id.replaceAll('{','').replaceAll('}','').replaceAll('-','');var $6=window.open($4,'drillOpen',String.format('height={0},width={1}',$2,$3));$6.focus();}catch($7){}}
Type.registerNamespace('ClientUI.Views');ClientUI.Views.NetworkView=function(viewModel){this.$F=Date.get_now();this.height=$(window).height();this.width=$(window).width();this.vm=viewModel;this.$3=d3.layout.force().size([this.width,this.height]).linkDistance(150).friction(0.7).charge(-700).on('tick',ss.Delegate.create(this,this.tick));this.$9=d3.behavior.zoom().scaleExtent([this.$0,this.$1]).center([this.width/2,this.height/2]).on('zoom',ss.Delegate.create(this,this.zoomed));this.$4=d3.select('#networksvg').attr('width',this.width).attr('height',this.height).call(this.$9).append('g');this.$7=this.$3.drag().on('dragstart',ss.Delegate.create(this,this.dragstart));this.$8=d3.select('#infoBox').style('opacity',0);this.$A=this.$3.nodes();this.$B=this.$3.links();this.$5=this.$4.selectAll('.link');this.$6=this.$4.selectAll('.node');this.update();SparkleXrm.ViewBase.registerViewModel(this.vm);this.vm.add_onNewNodes(ss.Delegate.create(this,this.$16));this.vm.add_onSelectedNodesAdded(ss.Delegate.create(this,this.$15));this.vm.add_onSelectedNodesCleared(ss.Delegate.create(this,this.$14));this.vm.add_onSelectedLinksAdded(ss.Delegate.create(this,this.$11));this.vm.add_onInfoBoxClose(ss.Delegate.create(this,this.$13));this.vm.add_onZoom(ss.Delegate.create(this,this.$12));$(window).resize(ss.Delegate.create(this,this.$17));$(ss.Delegate.create(this,function(){
window.setTimeout(ss.Delegate.create(this,function(){
this.vm.processQueue();}),10);}));}
ClientUI.Views.NetworkView.Init=function(){SparkleXrm.LocalisedContentLoader.fallBackLCID=0;SparkleXrm.LocalisedContentLoader.supportedLCIDs.add(1033);SparkleXrm.LocalisedContentLoader.loadContent('dev1_/js/NetworkViewConfig.js',1033,function(){
var $1_0=ClientUI.Views.NetworkView.$18();if(!Object.keyExists($1_0,'etn')){$1_0['etn']='account';}var $1_1=new ClientUI.ViewModels.NetworkViewModel(new SparkleXrm.Sdk.Guid($1_0['id']),$1_0['etn'],window.GraphOptions);ClientUI.Views.NetworkView.view=new ClientUI.Views.NetworkView($1_1);});}
ClientUI.Views.NetworkView.$18=function(){if(window.location.search.length>0){var $0=window.location.search.split('=');var $1=decodeURIComponent($0[1]);var $2=$1.split('&');var $3={};var $enum1=ss.IEnumerator.getEnumerator($2);while($enum1.moveNext()){var $4=$enum1.current;var $5=$4.split('=');$3[$5[0]]=$5[1];}return $3;}return {};}
ClientUI.Views.NetworkView.$19=function($p0){var $0=d3.select('#'+$p0);if($0!=null){$0.attr('filter','url(#selected-glow)');$0.attr('class','link link-selected');}}
ClientUI.Views.NetworkView.$1A=function($p0){var $0=d3.select('#'+$p0);if($0!=null){$0.attr('filter',null);$0.attr('class','link');}}
ClientUI.Views.NetworkView.$1E=function($p0){if($p0.root){return 'url(#root-node-glow)';}else{return '';}}
ClientUI.Views.NetworkView.$23=function($p0){var $0=($p0.sourceData);var $1=0;switch($0.logicalName){case 'account':$1=15;break;case 'contact':$1=10;break;default:$1=20;break;}$1=$1+(($p0.root)?2:0);return $1;}
ClientUI.Views.NetworkView.prototype={vm:null,width:960,height:500,$0:0.2,$1:1.5,$2:null,$3:null,$4:null,$5:null,$6:null,$7:null,$8:null,$9:null,$A:null,$B:null,$C:false,$D:true,$E:null,$10:false,$11:function($p0,$p1){var $enum1=ss.IEnumerator.getEnumerator(this.vm.highlightedLinksToRemove());while($enum1.moveNext()){var $0=$enum1.current;ClientUI.Views.NetworkView.$1A($0);}this.vm.highlightedLinksToRemove.removeAll();var $enum2=ss.IEnumerator.getEnumerator(this.vm.HighlightedLinks());while($enum2.moveNext()){var $1=$enum2.current;ClientUI.Views.NetworkView.$19($1);}},$12:function($p0,$p1){this.$24($p1);},$13:function($p0,$p1){this.$1F();},$14:function($p0,$p1){var $enum1=ss.IEnumerator.getEnumerator(this.vm.highlightedEntities());while($enum1.moveNext()){var $0=$enum1.current;this.$1D($0);}},$15:function($p0,$p1){var $enum1=ss.IEnumerator.getEnumerator(this.vm.highlightedEntitiesToRemove());while($enum1.moveNext()){var $0=$enum1.current;this.$1D($0);}this.vm.highlightedEntitiesToRemove.removeAll();var $enum2=ss.IEnumerator.getEnumerator(this.vm.highlightedEntities());while($enum2.moveNext()){var $1=$enum2.current;this.$1C($1);}},$16:function($p0,$p1){if(this.vm.suspendLayout){return;}this.$A.clear();var $0=this.vm.nodes;for(var $2=0;$2<$0.length;$2++){this.$A.push($0[$2]);}this.$B.clear();var $1=this.vm.links;for(var $3=0;$3<$1.length;$3++){this.$B.push($1[$3]);}this.update();if($p1==null){this.fastForward(this.$3,0.01,100);}else{this.$3.friction(0.01);this.fastForward(this.$3,0.09,100);this.$3.friction(0.9);this.update();}},$17:function($p0){var $0=$(window).height();var $1=$(window).width();d3.select('#networksvg').attr('width',$1).attr('height',$0);},zoomed:function(d,i){this.$4.attr('transform','translate('+d3.event.translate+')scale('+d3.event.scale+')');},dragstart:function(d,i){d.fixed=true;d3.event.sourceEvent.stopPropagation();},dragmove:function(d,i){d.px+=d3.event.dx;d.py+=d3.event.dy;d.x+=d3.event.dx;d.y+=d3.event.dy;this.tick(null,0);},dragend:function(d,i){d.fixed=true;this.tick(null,0);this.$3.resume();},tick:function(n,i){this.$5.attr('x1',function($p1_0){
return $p1_0.source.x;}).attr('y1',function($p1_0){
return $p1_0.source.y;}).attr('x2',function($p1_0){
return $p1_0.target.x;}).attr('y2',function($p1_0){
return $p1_0.target.y;});this.$6.attr('cx',function($p1_0){
return $p1_0.x;}).attr('cy',function($p1_0){
return $p1_0.y;});this.$6.attr('transform',function($p1_0){
return 'translate('+$p1_0.x+','+$p1_0.y+')';});},$1B:function($p0){return 'ID'+$p0.replaceAll('-','').toLowerCase();},$1C:function($p0){var $0=this.$1B($p0.id.toString());d3.select('#'+$0).selectAll('.entityImage').attr('filter','url(#selected-glow)');d3.select('#'+$0).selectAll('.entityImage').transition().attr('transform','scale(0.6)').transition().attr('transform','scale(2)');},$1D:function($p0){var $0=this.$1B($p0.id.toString());var $1=this.vm.idIndex[$0];d3.select('#'+$0).selectAll('.entityImage').attr('filter','url(#no-glow)');d3.select('#'+$0).selectAll('.entityImage').transition().attr('transform','scale(1)');},update:function(){this.$4.selectAll('text').remove();this.$4.selectAll('image').remove();this.$5=this.$5.data(this.$B,function($p1_0){
var $1_0=($p1_0).id;return $1_0;});this.$6=this.$6.data(this.$A,function($p1_0){
var $1_0=(($p1_0).sourceData).id;return $1_0;});this.$5.enter().insert('svg:line','.node').attr('id',function($p1_0){
return $p1_0.id;}).attr('class','link');this.$6.enter().append('svg:g').attr('id',ss.Delegate.create(this,function($p1_0){
var $1_0=$p1_0.sourceData;return this.$1B($1_0.id);})).attr('class','node').attr('filter','url(#blur1)').on('click',ss.Delegate.create(this,function($p1_0,$p1_1){
this.$20($p1_0);this.$22($p1_0,true);})).on('mouseover',ss.Delegate.create(this,function($p1_0,$p1_1){
this.$20($p1_0);if(!this.$10){this.$22($p1_0,false);}})).on('mouseout',ss.Delegate.create(this,function($p1_0,$p1_1){
this.$21($p1_0);if(this.$D||this.$10){return;}this.$1F();})).on('dblclick',ss.Delegate.create(this,function($p1_0,$p1_1){
$p1_0.fixed=false;d3.event.stopPropagation();var $1_0=$p1_0;this.vm.expandOverflow($1_0);})).call(this.$7);this.$6.append('svg:image').attr('class','chromeImage').attr('xlink:href',function($p1_0){
var $1_0=($p1_0.sourceData);switch($1_0.logicalName){case 'account':case 'contact':return '../images/network.png';default:return null;}}).attr('x',ss.Delegate.create(this,function($p1_0){
return this.getXY($p1_0,1.5);})).attr('y',ss.Delegate.create(this,function($p1_0){
return this.getXY($p1_0,1.5);})).attr('width',ss.Delegate.create(this,function($p1_0){
return this.getHeightWidth($p1_0,1.5);})).attr('height',ss.Delegate.create(this,function($p1_0){
return this.getHeightWidth($p1_0,1.5);})).attr('visibility',function($p1_0){
var $1_0=($p1_0.sourceData);switch($1_0.logicalName){case 'account':case 'contact':return null;default:return 'hidden';}}).attr('filter',function($p1_0){
return ClientUI.Views.NetworkView.$1E($p1_0);});this.$6.append('svg:image').attr('class','entityImage').attr('xlink:href',function($p1_0){
var $1_0=($p1_0.sourceData);switch($1_0.logicalName){case 'overflow':return '../images/overflow.png';case 'account':return '../images/account.png';case 'contact':return '../images/contact.png';case 'incident':return '/_imgs/Navbar/ActionImgs/Cases_32.png';case 'contract':return '/_imgs/Navbar/ActionImgs/Contract_32.png';case 'opportunity':return '/_imgs/Navbar/ActionImgs/Opportunity_32.png';case 'lead':return '/_imgs/Navbar/ActionImgs/Lead_32.png';case 'phonecall':return '/_imgs/Navbar/ActionImgs/PhoneCall_32.png';case 'email':return '/_imgs/Navbar/ActionImgs/Email_32.png';case 'task':return '/_imgs/Navbar/ActionImgs/Task_32.png';case 'appointment':return '/_imgs/Navbar/ActionImgs/Appointment_32.png';default:return '/_imgs/Navbar/ActionImgs/Documents_32.png';}}).attr('x',ss.Delegate.create(this,function($p1_0){
return this.getXY($p1_0,0.5);})).attr('y',ss.Delegate.create(this,function($p1_0){
return this.getXY($p1_0,0.5);})).attr('width',ss.Delegate.create(this,function($p1_0){
return this.getHeightWidth($p1_0,0.5);})).attr('height',ss.Delegate.create(this,function($p1_0){
return this.getHeightWidth($p1_0,0.5);})).attr('filter','url(#blur2)');this.$6.append('svg:text').attr('class','nodetext').attr('dx',function($p1_0){
var $1_0=($p1_0.sourceData);switch($1_0.logicalName){case 'overflow':return -3;default:return -15;}}).attr('dy',function($p1_0){
var $1_0=($p1_0.sourceData);switch($1_0.logicalName){case 'overflow':return 3;default:return -15;}}).text(ss.Delegate.create(this,function($p1_0){
var $1_0=$p1_0.sourceData;if($1_0.logicalName==='overflow'){if($p1_0.children!=null){return $p1_0.children.length.toString();}return '';}else{var $1_1=this.vm.config.entities[$1_0.logicalName];var $1_2=$1_0.getAttributeValueString(($1_1!=null&&$1_1.nameAttribute!=null)?$1_1.nameAttribute:'name');if($1_2!=null&&$1_2.length>50){$1_2=$1_2.substr(0,50)+'...';}return $1_2;}}));this.$5.exit().remove();this.$6.exit().remove();this.$3.start();var $0={};var $enum1=ss.IEnumerator.getEnumerator(this.vm.links);while($enum1.moveNext()){var $1=$enum1.current;var $2=$1.id;if(Object.keyExists($0,$2)){}else{$0[$2]=$2;}}var $enum2=ss.IEnumerator.getEnumerator(this.vm.nodes);while($enum2.moveNext()){var $3=$enum2.current;var $4=(($3).sourceData).id;if(Object.keyExists($0,$4)){}else{$0[$4]=$4;}}},$1F:function(){this.$10=false;this.$8.style('opacity','0');this.$8.transition().style('left',-1000+'px').style('top',-1000+'px');},$20:function($p0){var $0=d3.select(d3.event.target.parentNode).selectAll('.chromeImage');var $1=d3.select(d3.event.target.parentNode).selectAll('.entityImage');$0.transition().attr('transform','scale(1.2)');$1.transition().attr('transform','scale(2)');},$21:function($p0){var $0=d3.select(d3.event.target.parentNode).selectAll('image');$0.transition().attr('transform','scale(1)');},$22:function($p0,$p1){var $0=$p0;this.vm.SelectedNode($0);if($p1){if(($0.sourceData).id===this.$E){this.$10=false;}else{this.$10=true;this.$E=($0.sourceData).id;}}this.$8.style('opacity','1');var $1=d3.select(d3.event.target.parentNode).selectAll('image');var $2=$1.node().getScreenCTM().translate($1.node().getAttribute('cx'),$1.node().getAttribute('cy'));var $3=$(window).width();var $4=$(window).height();var $5=(window.pageXOffset+$2.e)+50;var $6=(window.pageYOffset+$2.f)-10;if($6+100>$4){$6=$4-100;}$5=20;this.$8.transition().style('left',$5+'px').style('top',$6+'px');},getXY:function(node,multipler){var $0=0;var $1=(node.sourceData);$0=ClientUI.Views.NetworkView.$23(node);return '-'+($0*multipler).toString()+'px';},getHeightWidth:function(node,multipler){var $0=0;var $1=(node.sourceData);$0=ClientUI.Views.NetworkView.$23(node)*2;return ($0*multipler).toString()+'px';},fastForward:function(layout,alpha,max){var $0=0;while((layout.alpha()>alpha)&&($0<max)&&!this.vm.cancelRequested){layout.tick();$0++;}},$24:function($p0){this.$4.call(this.$9.event);var $0=this.$9.center();var $1=this.$9.translate();var $2=this.$25($0);var $3=this.$9.scale();$3=$3*Math.pow(1.5,$p0);if($3<=this.$0){$3=this.$0;}else if($3>=this.$1){$3=this.$1;}this.$9.scale($3);var $4=this.$26($2);this.$9.translate([$1[0]+$0[0]-$4[0],$1[1]+$0[1]-$4[1]]);this.$4.transition().duration(750).call(this.$9.event);},$25:function($p0){var $0=this.$9.scale();var $1=this.$9.translate();return [($p0[0]-$1[0])/$0,($p0[1]-$1[1])/$0];},$26:function($p0){var $0=this.$9.scale();var $1=this.$9.translate();return [$p0[0]*$0+$1[0],$p0[1]*$0+$1[1]];}}
ClientUI.ResourceStrings.registerClass('ClientUI.ResourceStrings');ClientUI.ViewModels.EntityLink.registerClass('ClientUI.ViewModels.EntityLink');ClientUI.ViewModels.EntityNodeLink.registerClass('ClientUI.ViewModels.EntityNodeLink');ClientUI.ViewModels.EntityNode.registerClass('ClientUI.ViewModels.EntityNode');ClientUI.ViewModels.FormCell.registerClass('ClientUI.ViewModels.FormCell');ClientUI.ViewModels.NetworkViewModel.registerClass('ClientUI.ViewModels.NetworkViewModel',SparkleXrm.ViewModelBase);ClientUI.ViewModels.PendingLink.registerClass('ClientUI.ViewModels.PendingLink');ClientUI.ViewModels.UserOrTeam.registerClass('ClientUI.ViewModels.UserOrTeam',SparkleXrm.Sdk.Entity);ClientUI.ViewModels.ActivityParty.registerClass('ClientUI.ViewModels.ActivityParty',SparkleXrm.Sdk.Entity);ClientUI.ViewModels.Connection.registerClass('ClientUI.ViewModels.Connection',SparkleXrm.Sdk.Entity);ClientUI.ViewModels.QueuedLoad.registerClass('ClientUI.ViewModels.QueuedLoad');ClientUI.ViewModels.XrmForm.registerClass('ClientUI.ViewModels.XrmForm');ClientUI.Views.NetworkView.registerClass('ClientUI.Views.NetworkView');ClientUI.ResourceStrings.possibleInfiniteLoop="Whoa! I'm going around in circles. Do you have an infinite loop in your configuration?";ClientUI.ResourceStrings.loading='Loading';ClientUI.ResourceStrings.connections='Connections';ClientUI.ResourceStrings.processing='Processing';ClientUI.ResourceStrings.querying='Querying';ClientUI.ResourceStrings.linking='Linking';ClientUI.ResourceStrings.recordLimitExceeded="You've got lots to look at here!";ClientUI.ResourceStrings.activities='Activities';ClientUI.ResourceStrings.activityLinks='Activity Links';ClientUI.ResourceStrings.doubleClickToExpand='Double Click to Expand';ClientUI.ResourceStrings.statusMessage='Records {2}: {0} {1}...';ClientUI.ResourceStrings.noConfigurationError='No Configuration';ClientUI.ViewModels.UserOrTeam.entityLogicalName='systemuser';ClientUI.ViewModels.ActivityParty.entityLogicalName='activityparty';ClientUI.ViewModels.Connection.entityLogicalName='connection';ClientUI.Views.NetworkView.view=null;})(window.xrmjQuery);